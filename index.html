
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVGmd - 文本冒险游戏</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang SC", "Microsoft YaHei";
            background: radial-gradient(1200px 600px at 80% -100%, rgba(56,189,248,0.2), transparent),
                        linear-gradient(135deg, #0f172a, #1e293b 60%, #0b1220);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            max-width: 980px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 28px;
            letter-spacing: .5px;
            color: #ffffff;
            margin-bottom: 14px;
            text-shadow: 0 2px 6px rgba(0,0,0,.4);
        }
        h3 {
            color: #e5e7eb;
            margin-top: 0;
            font-size: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,.08);
        }
        /* 内容面板（故事与说明） */
        #story, #story2 {
            background: rgba(0,0,0,.22);
            border: 1px solid rgba(255,255,255,.1);
            border-radius: 12px;
            padding: 18px 18px 18px 18px;
            margin-bottom: 16px;
            line-height: 1.7;
            letter-spacing: 0.4px;
            box-shadow: 0 10px 30px rgba(0,0,0,.25) inset;
        }
        #story { display: none; } /* 初始隐藏 */
        /* 选择按钮区域 */
        #choices {
            margin-top: 10px;
            display: flex;
            gap: 25px;
            justify-content: center;
            align-content: center;
            align-items: center;
            flex-wrap: wrap;
            perspective: 1000px;
            width: fit-content;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        #choices .choice { margin: 10px; }
        #nextButton, .button-container button {
            display: inline-block;
            margin: 6px;
            padding: 8px 16px;
            font-size: 15px;
            color: #fff;
            background: #111c32;
            border: 1px solid rgba(255,255,255,.16);
            border-radius: 16px;
            cursor: pointer;
            transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
            font-weight: 600;
        }
        /* 选项卡片样式（矩形 50x120） */
        .choice {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 250px;
            padding: 24px 6px 8px; /* 顶部序号留白 */
            font-size: 14px;
            color: #fff;
            background: linear-gradient(180deg, #17223d, #0f1a31);
            border: 1px solid rgba(255,255,255,.14);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            text-align: center;
            line-height: 1.2;
            word-break: break-word;
            box-shadow: 0 16px 40px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.06) inset;
            transform-style: preserve-3d;
            transform: translateZ(0) rotateX(0) rotateY(0);
            transition: transform .22s ease, box-shadow .22s ease, background .2s ease, border-color .2s ease;
            overflow: hidden; /* 防止内容溢出 */
        }
        /* 顶部序号角标：使用 data-index（玻璃浅蓝渐变、内外发光） */
        .choice::before {
            content: attr(data-index);
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            font-size: 13px;
            font-weight: 800;
            letter-spacing: .5px;
            color: #0b1220;
            background: linear-gradient(180deg, #e8f1ff, #b9d4ff 60%, #93c5fd);
            border: 1px solid rgba(255,255,255,.55);
            border-radius: 999px;
            box-shadow:
                0 6px 14px rgba(0,0,0,.35),
                inset 0 1px 0 rgba(255,255,255,.65);
            outline: 2px solid rgba(147,197,253,.25);
            outline-offset: 0;
            backdrop-filter: saturate(140%) blur(2px);
            transition: box-shadow .2s ease, transform .2s ease, background .3s ease;
            pointer-events: none;
        }
        #nextButton:hover, .button-container button:hover {
            background: #13213b;
            border-color: rgba(255,255,255,.3);
        }
        .choice:hover {
            background: #13213b;
            border-color: rgba(255,255,255,.28);
            box-shadow: 0 18px 36px rgba(0,0,0,.38);
        }
        /* 两个选项：左卡左倾、右卡右倾 */
        #choices.choices-2 .choice.pos-left:hover  { transform: translateY(-3px) rotateY(-10deg) rotateX(1deg); }
        #choices.choices-2 .choice.pos-right:hover { transform: translateY(-3px) rotateY( 10deg) rotateX(1deg); }
        /* 三个选项：中间后倾，两侧外倾 */
        #choices.choices-3 .choice.pos-left:hover  { transform: translateY(-3px) rotateY(-10deg) rotateX(1deg); }
        #choices.choices-3 .choice.pos-mid:hover   { transform: translateY(-4px) rotateX(8deg); }
        #choices.choices-3 .choice.pos-right:hover { transform: translateY(-3px) rotateY( 10deg) rotateX(1deg); }
        /* 其它数量：首左倾，末右倾，中间微后倾 */
        #choices:not(.choices-2):not(.choices-3) .choice.pos-left:hover  { transform: translateY(-3px) rotateY(-10deg) rotateX(1deg); }
        #choices:not(.choices-2):not(.choices-3) .choice.pos-right:hover { transform: translateY(-3px) rotateY( 10deg) rotateX(1deg); }
        #choices:not(.choices-2):not(.choices-3) .choice.pos-mid:hover   { transform: translateY(-3px) rotateX(6deg); }
        #nextButton:active, .button-container button:active {
            transform: translateY(1px);
        }
        #nextButton {
            display: none; /* 初始隐藏 */
        }
        /* 顶部输入区域 */
        .button-container {
            margin: 16px 0;
            text-align: center;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
            align-items: center;
        }
        .button-container input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            color: #e5e7eb;
            background: rgba(0,0,0,.28);
            border: 1px solid rgba(255,255,255,.12);
            border-radius: 10px;
            outline: none;
            transition: border-color .2s ease, background .2s ease;
        }
        .button-container input::placeholder { color: #94a3b8; }
        .button-container input:focus {
            border-color: rgba(56,189,248,.6);
            background: rgba(15,23,42,.6);
        }
        /* 图片缩放手势 */
        .min { max-height: 25px; }
        .showImg {
            cursor: zoom-in;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,.08);
            display: block;
            margin: 0 auto;
            width: 500px;
            max-width: 90vw;
            height: auto;
        }
        #bigImg { cursor: zoom-out; max-width: min(90vw, 1024px); max-height: 90vh; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,.5); }
        .img-container {
            display: block;
            margin: 10px auto;
            text-align: center;
        }
        /* 遮罩层优化 */
        #back-curtain {
            backdrop-filter: saturate(140%) blur(2px);
        }
        /* 链接与分隔线适配深色主题 */
        a { color: #93c5fd; }
        hr { border: none; border-top: 1px solid rgba(255,255,255,.12); margin: 10px 0; }
        /* 小屏适配 */
        @media (max-width: 768px) {
            body { padding: 16px; }
            h1 { font-size: 24px; }
            .button-container { grid-template-columns: 1fr; }
            #choices { gap: 25px; }
            .choice {
                width: 100%;
                height: 200px;
                font-size: 15px;
            }
            .choice::before { top: 8px; }
        }
        /* 隐藏全局滚动条但保留滚动功能 */
        html, body { -ms-overflow-style: none; scrollbar-width: none; }
        html::-webkit-scrollbar, body::-webkit-scrollbar { display: none; }
        /* 隐藏遮罩层内的滚动条 */
        #back-curtain { scrollbar-width: none; }
        #back-curtain::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
<h1>文本冒险游戏</h1>
<!-- 右键菜单（仅在已加载文本后使用） -->
<div id="h1Menu" style="position:absolute;display:none;background:rgba(15,23,42,.98);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:8px;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,.4);">
    <button id="btnHome" style="display:block;width:140px;margin:4px 0;padding:8px 10px;background:#111c32;color:#fff;border:1px solid rgba(255,255,255,.16);border-radius:8px;cursor:pointer;">首页</button>
    <button id="btnHistory" style="display:block;width:140px;margin:4px 0;padding:8px 10px;background:#111c32;color:#fff;border:1px solid rgba(255,255,255,.16);border-radius:8px;cursor:pointer;">历史</button>
</div>
<div id="story"></div>
<div id="choices"></div>
<button id="nextButton" onclick="showNextLine()">下一步</button>
<div class="button-container" style="display:none;">
    <input type="text" id="urlInput" placeholder="输入故事文本文件的URL" />
    <button id="submitButton" onclick="loadStoryFromURL()">提交</button>
    <button onclick="selectFile()">选择TXT/MD文件</button>
</div>

<input type="file" id="fileInput" accept=".txt,.md,text/plain,text/markdown" style="display:none;" />

<div id="story2" style="display:none;">
    <h3>使用方式</h3>
    场景1<br>
    这是一个故事，想看吗？<br>
    选择：想 -> 场景2<br>
    选择：不想 -> 场景3<br>
    <br>
    场景2<br>
    结束<br>
    <br>
    场景3<br>
    这是一个很久很久的故事。<br>
    选择：继续 -> 场景4<br>
    <br>
    就是这样写成txt，<选择：想 -> 场景2>就是选择的按键对应到场景2。然后会显示结束。<br>
    每次显示一行，如果需要多行可以使用\n<br>
    例如：<br>
    这是一个很久很久的故事。\n久到所有人忘记了。<br>
    <hr>
    支持插入图片，![](url)<br>
</div>

<!-- 遮罩区域（先将div隐藏）-->
<div id="back-curtain" style="position:fixed;top:0;left:0;background:rgba(0,0,0,0.5);z-index:998;width:100%;display:none;">
    <!--放大后的图片-->
    <div id="imgDiv" style="position:absolute;">
        <img id="bigImg" src="" />
    </div>
</div>

<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script type="text/javascript">
$(function(){
    if (window.jQuery && jQuery.fancybox) {
        $('[data-fancybox]').fancybox({});
    }
});

function imgShow(imgDiv, bigImg, _this, curtain) {
    // 图片路径
    var src = _this.attr("src");
    $(bigImg).attr("src", src);
    // 加载图片,获取当前点击图片的真实大小
    $("<img/>").attr("src", src).load(function(){
        var windowWidth = $(window).width();
        var windowHeight = $(window).height();
        var realWidth = this.width;
        var realHeight = this.height;
        var imgWidth, imgHeight;
        var scale = 0.8;
        if (realHeight > windowHeight * scale) {
            imgHeight = windowHeight * scale;
            imgWidth = imgHeight / realHeight * realWidth;
            if (imgWidth > windowWidth * scale) {
                imgWidth = windowWidth * scale;
            }
        } else if (realWidth > windowWidth * scale) {
            imgWidth = windowWidth * scale;
            imgHeight = imgWidth / realWidth * realHeight;
        } else {
            imgWidth = realWidth;
            imgHeight = realHeight;
        }
        $(bigImg).css({'width':imgWidth});
        //计算图片与窗口左边距
        var left = (windowWidth - imgWidth) / 2;
        //计算图片与窗口上边距 
        var top = (windowHeight - imgHeight) / 2;
        // 图片位置
        $(imgDiv).css({'top':top, 'left':left});
        // 图片淡入
        $(curtain).fadeIn("fast");
        // 遮罩效果
        $(curtain).css({
            'position':'fixed',
            'overflow-y':'auto',
            'width':'100%',
            'height':'100%',
            'z-index':'998'
        }).show();
    });
    // 点击图片或遮罩，图片淡出
    $(curtain).on('click', function(){
        $(this).fadeOut("fast");
    });
}

let story = {};
let currentScene = "";
let currentLine = 0;
let lines = [];

// 持久化支持
let storyText = '';
let isRestoring = false;
const SAVE_KEY = 'avgmd_state_v1';

function saveState() {
    try {
        // 若开启了禁用自动加载/保存的开关，则直接跳过保存
        try { if (sessionStorage.getItem('avgmd_disable_autoload') === '1') return; } catch (e) {}
        const h1 = document.querySelector('h1');
        const curTitle = h1 ? h1.textContent : document.title || '文本冒险游戏';

        // 本次准备写入的 storyText；优先 window.storyText
        const newStoryText = (typeof window !== 'undefined' && typeof window.storyText !== 'undefined')
          ? window.storyText
          : (typeof storyText !== 'undefined' ? storyText : '');

        // 读取旧存档
        let old = null;
        try { old = JSON.parse(localStorage.getItem(SAVE_KEY) || 'null'); } catch (_) {}

        // 当本次 storyText 为空但旧存档存在时，沿用旧的 storyText 与 title，避免覆盖有效存档
        const finalStoryText = (newStoryText && String(newStoryText).length > 0)
          ? newStoryText
          : (old && old.storyText ? old.storyText : '');

        const finalTitle = (curTitle && curTitle.trim().length > 0)
          ? curTitle
          : (old && old.title ? old.title : '文本冒险游戏');

        // 若仍然拿不到文本，放弃保存，避免写入空存档
        if (!finalStoryText) {
            return;
        }

        // 场景保护：若处于恢复保护期且当前场景可疑，则沿用旧场景
        let finalScene = currentScene;
        const nowTs = Date.now ? Date.now() : new Date().getTime();
        const guardOn = (typeof window !== 'undefined' && typeof window.restoreGuardUntil !== 'undefined')
          ? (nowTs < window.restoreGuardUntil)
          : false;
        if (guardOn && old && old.currentScene && (!finalScene || finalScene === '场景1')) {
            finalScene = old.currentScene;
        }

        // 若与旧存档完全一致，跳过保存，避免不必要写入
        if (old
            && old.title === finalTitle
            && old.storyText === finalStoryText
            && old.currentScene === finalScene
            && old.currentLine === currentLine) {
            return;
        }

        // 版本号与时间戳（用于多窗口“以最新为准”）
        const prevVer = (old && typeof old.version === 'number') ? old.version : 0;
        const version = prevVer + 1;
        const updatedAt = Date.now ? Date.now() : (new Date().getTime());

        const state = {
            title: finalTitle,
            storyText: finalStoryText,
            currentScene: finalScene,
            currentLine,
            version,
            updatedAt
        };
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        try { window.lastVersion = (typeof state.version === 'number') ? state.version : (window.lastVersion || 0); } catch (e) {}
        try { window.lastUpdatedAt = (typeof state.updatedAt === 'number') ? state.updatedAt : (window.lastUpdatedAt || (Date.now ? Date.now() : new Date().getTime())); } catch (e) {}
    } catch (e) {
        console.warn('保存进度失败：', e);
    }
}
function loadState() {
    try {
        const raw = localStorage.getItem(SAVE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
    } catch (e) {
        console.warn('读取进度失败：', e);
        return null;
    }
}
function clearState() {
    try {
        localStorage.removeItem(SAVE_KEY);
        // 设置禁用自动加载开关，防止刷新后再次自动恢复/加载
        sessionStorage.setItem('avgmd_disable_autoload', '1');
    } catch (e) {}
}

// 标题设定与解析
function setGameTitle(title) {
    const h1 = document.querySelector('h1');
    const finalTitle = title && String(title).trim() ? String(title).trim() : '文本冒险游戏';
    if (h1) h1.textContent = finalTitle;
    document.title = finalTitle;
}
function deriveTitleFromFileName(name) {
    if (!name) return '文本冒险游戏';
    const base = String(name).split(/[\/\\]/).pop();
    return base.replace(/\.[^.]+$/, '') || '文本冒险游戏';
}
function deriveTitleFromURL(url) {
    if (!url) return '文本冒险游戏';
    try {
        const u = new URL(url);
        const last = (u.pathname || '').split('/').filter(Boolean).pop() || '';
        const raw = last.replace(/\.[^.]+$/, '');
        try {
            return decodeURIComponent(raw) || '文本冒险游戏';
        } catch (e2) {
            return raw || '文本冒险游戏';
        }
    } catch (e) {
        const base = String(url).split('?')[0].split('#')[0];
        const last = base.split('/').pop() || '';
        const raw = last.replace(/\.[^.]+$/, '');
        try {
            return decodeURIComponent(raw) || '文本冒险游戏';
        } catch (e3) {
            return raw || '文本冒险游戏';
        }
    }
}

function selectFile() {
    const fileInput = document.getElementById('fileInput');
    fileInput.click();
    fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (file) {
            const name = (file.name || '').toLowerCase();
            const type = (file.type || '').toLowerCase();
            if (!(name.endsWith('.txt') || name.endsWith('.md') || type === 'text/plain' || type === 'text/markdown')) {
                alert('仅支持 .txt 或 .md 文件');
                fileInput.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result.trim();
                parseStory(text);
                try { window.storyText = text; } catch (e) {}
                try { storyText = text; } catch (e) {}
                // 清除禁用开关，恢复正常持久化
                try { sessionStorage.removeItem('avgmd_disable_autoload'); } catch (e) {}
                // 根据本地文件名设置标题
                setGameTitle(deriveTitleFromFileName(file.name));
                currentScene = '场景1';
                currentLine = 0;
                displayScene(currentScene);
                document.getElementById('story').style.display = 'block'; // 显示故事
                document.getElementById('story2').style.display = 'none';
                const btnWrap = document.querySelector('.button-container');
                if (btnWrap) btnWrap.style.display = 'none';
                try { if (typeof saveState === 'function') saveState(); } catch (e) {}
            };
            reader.readAsText(file);
        }
    };
}

// 监听键盘事件
document.addEventListener('keydown', function(event) {
    // 若在输入框/可编辑区域内，忽略快捷键
    const ae = document.activeElement;
    const isTyping = ae && (
        ae.tagName === 'INPUT' ||
        ae.tagName === 'TEXTAREA' ||
        ae.isContentEditable
    );
    if (isTyping) return;

    // Enter：沿用原有逻辑
    if (event.key === 'Enter') {
        if (document.activeElement === document.getElementById('urlInput')) {
            loadStoryFromURL();
        } else {
            showNextLine();
        }
        return;
    }

    // S / s：下一页
    if (event.key === 's' || event.key === 'S') {
        event.preventDefault();
        try { showNextLine(); } catch(_) {}
        return;
    }

    // 数字键 1-9（含小键盘）：选择对应选项
    // event.key 对于顶部数字与小键盘数字通常都是 '1'..'9'
    if (/^[1-9]$/.test(event.key)) {
        event.preventDefault();
        try {
            const choicesDiv = document.getElementById('choices');
            if (!choicesDiv) return;
            const btns = Array.prototype.slice.call(choicesDiv.querySelectorAll('button.choice'));
            const idx = parseInt(event.key, 10) - 1;
            if (idx >= 0 && idx < btns.length && typeof btns[idx].click === 'function') {
                btns[idx].click();
            }
        } catch(_) {}
        return;
    }
});

function loadStoryFromURL() {
    const urlInput = document.getElementById('urlInput');
    const url = urlInput.value.trim();
    if (!url) return;

    // 清空文件输入
    document.getElementById('fileInput').value = '';

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应错误，状态码：' + response.status);
            }
            return response.text();
        })
        .then(text => {
            parseStory(text);
            try { window.storyText = text; } catch (e) {}
            try { storyText = text; } catch (e) {}
            // 清除禁用开关，恢复正常持久化
            try { sessionStorage.removeItem('avgmd_disable_autoload'); } catch (e) {}
            // 根据 URL 文件名设置标题
            setGameTitle(deriveTitleFromURL(url));
            currentScene = '场景1';
            currentLine = 0;
            displayScene(currentScene);
            document.getElementById('story').style.display = 'block'; // 显示故事
            document.getElementById('story2').style.display = 'none';
            const btnWrap = document.querySelector('.button-container');
            if (btnWrap) btnWrap.style.display = 'none';
            try { if (typeof saveState === 'function') saveState(); } catch (e) {}
        })
        .catch(error => {
            console.error('加载失败：', error);
            alert('加载失败：' + error.message);
        });
}

function parseStory(text) {
    const scenes = text.split(/\n\s*\n/).map(scene => scene.trim());
    scenes.forEach(scene => {
        const lines = scene.split('\n').map(line => line.trim());
        const sceneName = lines[0];
        const content = lines.slice(1).join('<p>').trim();
        
        // 处理 Markdown 图片
        const processedContent = content.replace(/!\[.*?\]\((.*?)\)/g, '<div class="img-container"><a href="$1" data-fancybox="gallery"><img class="showImg" src="$1" alt="图片"></a></div>');
        
        story[sceneName] = processedContent.split('<p>').map(line => line.replace(/\\n/g, '<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'));
    });
}

function normalizeText(t) {
    return String(t)
        .replace(/<[^>]*>/g, '')        // 去除HTML标签
        .replace(/&nbsp;/g, ' ')        // 替换不间断空格
        .replace(/[\r\n]+/g, '')        // 去除换行符
        .replace(/^[\s\u3000]+|[\s\u3000]+$/g, '') // 去除前后空格（含全角空格）
        .trim();
}
function isEndLine(t) {
    const s = normalizeText(t);
    return /^结束[。\.!！、，…]*$/.test(s);
}

function displayScene(scene) {
    const storyDiv = document.getElementById('story');
    const choicesDiv = document.getElementById('choices');

    if (!story[scene]) {
        storyDiv.innerHTML = "场景不存在。";
        choicesDiv.innerHTML = "";
        return;
    }

    lines = story[scene];
    currentLine = 0;
    // 先清空并隐藏选择，再展示首行，避免首行立即出现选择时被清空
    choicesDiv.innerHTML = "";
    choicesDiv.style.display = 'none';
    showNextLine(); // 显示第一行
}

function showNextLine() {
    const storyDiv = document.getElementById('story');
    const choicesDiv = document.getElementById('choices');

    if (currentLine < lines.length) {
        const currentText = lines[currentLine];

        // 如果是选择行，直接展示选择（不需要额外再点一次）
        if (/^选择：/.test(currentText)) {
            // 跳过所有“选择：”行的内容展示，仅用于生成按钮
            // 将“请选择线路：”附加在当前文本之后显示
            if (!storyDiv.innerHTML.includes("请选择线路：")) {
                storyDiv.innerHTML += "<br>请选择线路：";
            }
            currentLine++; // 前移指针，避免下次仍落在选择行
            showChoices();
            document.getElementById('nextButton').style.display = 'none';
            return;
        }

        // 显示普通文本
        storyDiv.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + currentText;
        currentLine++;

        // 初始化 FancyBox 放大
        if (window.jQuery && jQuery.fancybox) {
            $('[data-fancybox]').fancybox({});
        }

        // 如果该行是“结束”，显示结局按钮并停止推进
        if (isEndLine(currentText)) {
            document.getElementById('nextButton').style.display = 'none';
            showEndButtons();
            return;
        }

        // 如果下一行就是选择，则立刻显示选择，避免多一次点击
        if (currentLine < lines.length && /^选择：/.test(lines[currentLine])) {
            storyDiv.innerHTML += "<br>请选择线路：";
            showChoices();
            document.getElementById('nextButton').style.display = 'none';
            choicesDiv.style.display = 'block';
        } else {
            // 否则正常显示“下一步”
            if (currentLine < lines.length) {
                document.getElementById('nextButton').style.display = 'block';
                choicesDiv.style.display = 'none';
            } else {
                document.getElementById('nextButton').style.display = 'none';
                // 到达场景末尾，直接显示结局按钮（兜底）
                showEndButtons();
                choicesDiv.style.display = 'block';
            }
        }
    }
    // 兜底：到达场景末尾时再次检查最后一行是否为“结束”
    else {
        const lastText = lines.length ? lines[lines.length - 1] : '';
        if (isEndLine(lastText)) {
            document.getElementById('nextButton').style.display = 'none';
            showEndButtons();
        }
    }
}

function showEndButtons() {
    const storyDiv = document.getElementById('story');
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = "";

    // 在故事框下加一行空行，确保按钮区域与正文有间距
    if (storyDiv) {
        storyDiv.innerHTML += "<br>";
    }

    const restartBtn = document.createElement('button');
    restartBtn.textContent = '再来一次';
    restartBtn.className = 'choice';
    restartBtn.onclick = () => {
        currentScene = '场景1';
        currentLine = 0;
        displayScene(currentScene);
        const btnWrap = document.querySelector('.button-container');
        if (btnWrap) btnWrap.style.display = 'none'; // 保持输入区隐藏
    };
    choicesDiv.appendChild(restartBtn);

    const endBtn = document.createElement('button');
    endBtn.textContent = '结束';
    endBtn.className = 'choice';
    endBtn.onclick = () => {
        try {
            // 仅清理本项目的键，避免影响同域其他站点
            localStorage.removeItem(SAVE_KEY); // 'avgmd_state_v1'
            localStorage.removeItem('avgmd_choice_history_v1');
        } catch(e) {}
        // 使用 clearState() 设置会话开关，避免刷新后自动恢复
        try { if (typeof clearState === 'function') clearState(); } catch (e) {}
        if (typeof resetToDefault === 'function') resetToDefault();
    };
    choicesDiv.appendChild(endBtn);

    // 强制显示并滚动到按钮区域，确保用户可见
    choicesDiv.style.display = 'block';
    try {
        choicesDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } catch (e) {}
}

function resetToDefault() {
    const storyDiv = document.getElementById('story');
    const choicesDiv = document.getElementById('choices');
    const guideDiv = document.getElementById('story2');
    const btnWrap = document.querySelector('.button-container');

    storyDiv.style.display = 'none';
    storyDiv.innerHTML = '';
    choicesDiv.innerHTML = '';
    choicesDiv.style.display = 'none';
    if (guideDiv) guideDiv.style.display = 'block';
    if (btnWrap) btnWrap.style.display = 'block';

    // 还原默认标题
    setGameTitle('文本冒险游戏');

    currentScene = '';
    currentLine = 0;
    lines = [];
}

function showChoices() {
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = "";

    const choices = lines.join('\n').match(/选择：(.+?) -> (场景\d+)/g);
    if (choices) {
        choices.forEach(choice => {
            const match = choice.match(/选择：(.+?) -> (场景\d+)/);
            if (match) {
                const choiceText = match[1].trim();
                const nextScene = match[2].trim();
                const button = document.createElement('button');
                button.textContent = choiceText;
                button.className = 'choice';
                button.onclick = () => {
                    try { if (typeof addChoiceHistory === 'function') addChoiceHistory(choiceText, nextScene); } catch(_) {}
                    currentScene = nextScene;
                    currentLine = 0; // 重置行数
                    displayScene(currentScene);
                    try { if (typeof saveState === 'function') saveState(); } catch (e) {}
                };
                choicesDiv.appendChild(button);
            }
        });
        choicesDiv.style.display = 'block'; // 显示选择按钮
    } else {
        choicesDiv.style.display = 'none'; // 如果没有选择，隐藏选择按钮
    }
}
</script>
<script>
// 覆写 showChoices：为选项按钮添加位置类，配合 CSS 产生卡片 3D 倾斜动效
(function() {
    if (typeof showChoices === 'function') {
        const _origShowChoices = showChoices;
        window.showChoices = function() {
            const choicesDiv = document.getElementById('choices');
            if (!choicesDiv) return _origShowChoices();

            // 运行原逻辑，生成按钮
            _origShowChoices();

            // 统计并标注数量类
            const btns = Array.prototype.slice.call(choicesDiv.querySelectorAll('button.choice'));
            const total = btns.length;

            choicesDiv.classList.remove('choices-2','choices-3','choices-4','choices-5');
            if (total >= 2 && total <= 5) {
                choicesDiv.classList.add('choices-' + total);
            }

            // 清理旧位置类，标注序号与位置类
            btns.forEach(b => b.classList.remove('pos-left','pos-mid','pos-right'));
            btns.forEach((btn, idx) => {
                // 设置顶部显示的序号（1,2,3...）
                btn.setAttribute('data-index', String(idx + 1));

                if (total === 2) {
                    btn.classList.add(idx === 0 ? 'pos-left' : 'pos-right');
                } else if (total === 3) {
                    btn.classList.add(idx === 1 ? 'pos-mid' : (idx === 0 ? 'pos-left' : 'pos-right'));
                } else if (total > 3) {
                    if (idx === 0) btn.classList.add('pos-left');
                    else if (idx === total - 1) btn.classList.add('pos-right');
                    else btn.classList.add('pos-mid');
                }
            });
        };
    }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  try {
    // 若禁用开关存在，直接显示引导与输入区，跳过恢复与URL加载
    if (sessionStorage.getItem('avgmd_disable_autoload') === '1') {
      const guideDiv = document.getElementById('story2');
      const btnWrap = document.querySelector('.button-container');
      const storyDiv = document.getElementById('story');
      if (storyDiv) { storyDiv.style.display = 'none'; storyDiv.innerHTML = ''; }
      if (guideDiv) guideDiv.style.display = 'block';
      if (btnWrap) btnWrap.style.display = 'block';
      return;
    }
    // 如果已有本地存档，则优先恢复并跳过 URL 自动加载
    const saved = localStorage.getItem('avgmd_state_v1');
    if (saved) {
      // 存档恢复逻辑在后续“刷新持久化补丁”脚本中执行，这里直接跳过
      return;
    }

    // 若无存档，尝试 URL 参数直达
    const params = new URLSearchParams(window.location.search);
    const md = params.get('md') || params.get('url');
    if (md) {
      const urlInput = document.getElementById('urlInput');
      if (urlInput) urlInput.value = md;
      if (typeof loadStoryFromURL === 'function') {
        loadStoryFromURL();
      }
      return;
    }

    // 无存档且无URL：显示引导与输入区（初始默认隐藏避免闪烁）
    const guideDiv = document.getElementById('story2');
    const btnWrap = document.querySelector('.button-container');
    if (guideDiv) guideDiv.style.display = 'block';
    if (btnWrap) btnWrap.style.display = 'block';
  } catch (e) {
    console.error('URL 参数解析失败：', e);
  }
});
</script>
<script>
// 刷新持久化补丁（不侵入原函数实现）
(function () {
  const w = window;

  // 保障已有对象
  try { if (typeof w.storyText === 'undefined') w.storyText = ''; } catch (e) {}

  // 包装 parseStory：记录原始文本
  if (typeof w.parseStory === 'function') {
    const _origParseStory = w.parseStory;
    w.parseStory = function (text) {
      try { w.storyText = text; } catch (e) {}
      try { storyText = text; } catch (e) {}
      return _origParseStory.call(this, text);
    };
  }

  // 包装 displayScene：展示场景后保存
  if (typeof w.displayScene === 'function') {
    const _origDisplayScene = w.displayScene;
    w.displayScene = function (scene) {
      const r = _origDisplayScene.call(this, scene);
      try { if (!w.isRestoring && typeof w.saveState === 'function') w.saveState(); } catch (e) {}
      return r;
    };
  }

  // 包装 showNextLine：推进一行后保存
  if (typeof w.showNextLine === 'function') {
    const _origShowNextLine = w.showNextLine;
    w.showNextLine = function () {
      // 场景级存档：不在逐行推进时保存，防止把行进度覆盖为非零
      return _origShowNextLine.call(this);
    };
  }

  // 包装 resetToDefault：清除保存
  if (typeof w.resetToDefault === 'function') {
    const _origReset = w.resetToDefault;
    w.resetToDefault = function () {
      try { if (typeof w.clearState === 'function') w.clearState(); } catch (e) {}
      return _origReset.call(this);
    };
  }

  // 优先从本地存储恢复：可立即执行，也会在 DOMContentLoaded 兜底执行
  function restoreFromLocal() {
    try {
      const raw = localStorage.getItem('avgmd_state_v1');
      if (!raw) return false;
      const saved = JSON.parse(raw);
      if (!saved || !saved.storyText) return false;

      // 记录当前存档版本/时间用于跨窗口比较（时间戳优先）
      try { w.lastVersion = (typeof saved.version === 'number') ? saved.version : 0; } catch (e) {}
      try { w.lastUpdatedAt = (typeof saved.updatedAt === 'number') ? saved.updatedAt : ((Date.now ? Date.now() : new Date().getTime())); } catch (e) {}
      // 标记恢复流程，避免在恢复过程中触发自动保存
      w.isRestoring = true;

      // 显式填充 storyText，全局与 window 均设置，保证后续 saveState 能读到
      try { w.storyText = saved.storyText; } catch (e) {}
      try { storyText = saved.storyText; } catch (e) {}

      if (typeof w.parseStory === 'function') w.parseStory(saved.storyText);
      if (typeof w.setGameTitle === 'function') w.setGameTitle(saved.title || '文本冒险游戏');
      w.currentScene = saved.currentScene || '场景1';

      if (typeof w.displayScene === 'function') w.displayScene(w.currentScene);

      // 场景级恢复：不回放到具体行，始终从场景开头开始

      // UI：隐藏引导与输入区，显示故事
      const guideDiv = document.getElementById('story2');
      const btnWrap = document.querySelector('.button-container');
      const storyDiv = document.getElementById('story');
      if (guideDiv) guideDiv.style.display = 'none';
      if (btnWrap) btnWrap.style.display = 'none';
      if (storyDiv) storyDiv.style.display = 'block';

      // 恢复结束：开启2秒保护期，防止误写回初始场景；再标准化保存一次
      w.isRestoring = false;
      try { w.restoreGuardUntil = (Date.now ? Date.now() : new Date().getTime()) + 2000; } catch (e) {}
      if (typeof w.saveState === 'function') w.saveState();

      return true;
    } catch (e) {
      console.error('恢复失败：', e);
      return false;
    }
  }

  // 先尝试立即恢复；若此时文档尚未就绪，再在 DOMContentLoaded 执行一次兜底
  (function ensureRestore() {
    const restored = restoreFromLocal();
    if (!restored) {
      document.addEventListener('DOMContentLoaded', function () {
        restoreFromLocal();
      });
    }
  })();

  // 跨窗口监听：当其它窗口写入更新的存档时，本窗口自动切到最新
  window.addEventListener('storage', function (e) {
    if (e && e.key === 'avgmd_state_v1' && e.newValue) {
      try {
        const incoming = JSON.parse(e.newValue);
        if (!incoming) return;
        const incomingTs = (typeof incoming.updatedAt === 'number') ? incoming.updatedAt : 0;
        const curTs = (typeof w.lastUpdatedAt === 'number') ? w.lastUpdatedAt : ((typeof w.lastVersion === 'number') ? w.lastVersion : 0);
        if (incomingTs > curTs) {
          try { w.lastUpdatedAt = incomingTs; } catch (_) {}
          try { w.lastVersion = (typeof incoming.version === 'number') ? incoming.version : (w.lastVersion || 0); } catch (_) {}
          w.isRestoring = true;
          try { w.storyText = incoming.storyText; } catch (_) {}
          try { storyText = incoming.storyText; } catch (_) {}
          if (typeof w.parseStory === 'function') w.parseStory(incoming.storyText);
          if (typeof w.setGameTitle === 'function') w.setGameTitle(incoming.title || '文本冒险游戏');
          w.currentScene = incoming.currentScene || '场景1';
          if (typeof w.displayScene === 'function') w.displayScene(w.currentScene);
          const guideDiv = document.getElementById('story2');
          const btnWrap = document.querySelector('.button-container');
          const storyDiv = document.getElementById('story');
          if (guideDiv) guideDiv.style.display = 'none';
          if (btnWrap) btnWrap.style.display = 'none';
          if (storyDiv) storyDiv.style.display = 'block';
          w.isRestoring = false;
        }
      } catch (_) {}
    }
  });

  // 离开前兜底保存
  window.addEventListener('beforeunload', function () {
    try { if (typeof w.saveState === 'function') w.saveState(); } catch (e) {}
  });
})();
</script>
<!-- 历史弹窗 -->
<style>
  #historyModal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 10001; background: rgba(0,0,0,.5); }
  #historyModal .modal { background: #0f172a; border: 1px solid rgba(255,255,255,.12); border-radius: 12px; width: min(680px, 92vw); max-height: 80vh; overflow: auto; padding: 16px; color: #fff; box-shadow: 0 18px 36px rgba(0,0,0,.38); scrollbar-width: none; }
  #historyModal .modal header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  #historyModal .modal .close { cursor: pointer; background: transparent; border: none; color: #fff; font-size: 20px; padding: 4px 8px; border-radius: 6px; }
  #historyModal .modal .close:hover { background: rgba(255,255,255,.08); }
  .history-list { display: grid; gap: 10px; }
  .history-list .history-item, .history-go {
      display: inline-block; width: 100%; text-align: center;
      padding: 10px 12px; font-size: 15px; color: #fff; background: #111c32;
      border: 1px solid rgba(255,255,255,.16); border-radius: 10px; cursor: pointer;
      transition: background .2s ease, border-color .2s ease, transform .06s ease;
  }
  .history-list .history-item:hover, .history-go:hover { background: #13213b; border-color: rgba(255,255,255,.3); }
  #historyModal .modal::-webkit-scrollbar { display: none; }
  /* 预览折叠样式已移除（历史仅显示选择） */
</style>
<div id="historyModal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
  <div class="modal">
    <header>
      <h3 id="historyTitle" style="margin:0;">历史记录</h3>
      <button class="close" aria-label="关闭">×</button>
    </header>
    <div id="historyBody"></div>
  </div>
</div>
<script>
// 右键菜单与历史弹窗逻辑
(function(){
  const h1 = document.querySelector('h1');
  const menu = document.getElementById('h1Menu');
  const historyModal = document.getElementById('historyModal');
  const histBody = document.getElementById('historyBody');

  // 动态选择历史（仅记录“选择：xxx -> 场景N”）
  const HIST_KEY = 'avgmd_choice_history_v1';
  function readChoiceHistory() {
    try {
      const raw = localStorage.getItem(HIST_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch (_) { return []; }
  }
  function writeChoiceHistory(arr) {
    try { localStorage.setItem(HIST_KEY, JSON.stringify(arr || [])); } catch (_) {}
  }
  // 对外暴露，供 showChoices 的按钮点击时调用
  window.addChoiceHistory = function(choiceText, scene) {
    try {
      const label = String(choiceText || '').trim();
      const sc = String(scene || '').trim();
      if (!label || !sc) return;
      const item = { label: label + ' -> ' + sc, scene: sc, ts: Date.now ? Date.now() : (new Date().getTime()) };
      const list = readChoiceHistory();
      list.push(item);
      // 只保留最近 50 条
      writeChoiceHistory(list.slice(-50));
    } catch (_) {}
  };

  function storyLoaded() {
    const storyDiv = document.getElementById('story');
    const curScene = (typeof window !== 'undefined' && window.currentScene) ? window.currentScene : '';
    const hasWindowStory = (typeof window !== 'undefined') && window.story && Object.keys(window.story || {}).length > 0;
    let hasGlobalStory = false;
    try { hasGlobalStory = (typeof story !== 'undefined') && Object.keys(story || {}).length > 0; } catch(_) {}

    // 判断指定场景是否存在于任一 story 容器
    const sceneExists =
      !!curScene && (
        (hasWindowStory && window.story[curScene]) ||
        (hasGlobalStory && (typeof story !== 'undefined') && story[curScene])
      );

    // 视为“已加载”的条件更宽松：故事区可见 且 (有任何内容 或 当前场景有效)
    const storyVisible = !!(storyDiv && storyDiv.style.display !== 'none');
    return !!(storyVisible && (hasWindowStory || hasGlobalStory || sceneExists));
  }

  function showMenu(e) {
    if (!storyLoaded()) return; // 仅在加载文本后启用
    e.preventDefault();
    menu.style.display = 'block';
    // 位置：尽量不超出窗口
    const pad = 8;
    const vw = window.innerWidth, vh = window.innerHeight;
    const menuRect = { w: 160, h: 100 };
    let x = e.clientX, y = e.clientY;
    if (x + menuRect.w + pad > vw) x = vw - menuRect.w - pad;
    if (y + menuRect.h + pad > vh) y = vh - menuRect.h - pad;
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
  }
  function hideMenu() { if (menu) menu.style.display = 'none'; }

  if (h1) {
    h1.addEventListener('contextmenu', showMenu);
  }
  document.addEventListener('click', function(e){
    if (!menu) return;
    if (e.target === menu || menu.contains(e.target)) return;
    hideMenu();
  });

  // 首页：清理缓存并回到初始状态
  const btnHome = document.getElementById('btnHome');
  if (btnHome) {
    btnHome.addEventListener('click', function(){
      hideMenu();
      try {
        // 仅清理 AVGmd 的存储键，保留同域其他项目的数据
        localStorage.removeItem(SAVE_KEY);          // 'avgmd_state_v1'
        localStorage.removeItem(HIST_KEY);          // 'avgmd_choice_history_v1'
      } catch(_) {}
      // 调用 clearState 以设置禁用自动加载开关，避免刷新后自动恢复
      try { if (typeof clearState === 'function') clearState(); } catch(_) {}
      if (typeof resetToDefault === 'function') resetToDefault();
    });
  }

  // 历史：弹窗
  const btnHistory = document.getElementById('btnHistory');
  if (btnHistory) {
    btnHistory.addEventListener('click', function(){
      hideMenu();
      openHistoryModal();
    });
  }

  function openHistoryModal() {
    if (!historyModal || !histBody) return;
    histBody.innerHTML = '';
    const tip = document.createElement('div');
    tip.textContent = '选择一个历史记录：';
    tip.style.margin = '4px 0 8px';
    const list = document.createElement('div');
    list.className = 'history-list';

    const his = readChoiceHistory().slice().sort((a,b)=> (b.ts||0)-(a.ts||0));
    if (!his.length) {
      histBody.appendChild(tip);
      const empty = document.createElement('div');
      empty.textContent = '暂无历史记录';
      empty.style.color = '#94a3b8';
      empty.style.textAlign = 'center';
      empty.style.margin = '8px 0 4px';
      histBody.appendChild(empty);
      historyModal.style.display = 'flex';
      return;
    }
    his.forEach(it => {
      const b = document.createElement('button');
      b.className = 'history-item';
      b.textContent = it.label || (it.scene ? ('跳转到 ' + it.scene) : '未知记录');
      b.addEventListener('click', function(){
        try {
          if (it.scene) {
            window.currentScene = it.scene;
            window.currentLine = 0;
            if (typeof window.displayScene === 'function') window.displayScene(window.currentScene);
            if (typeof window.saveState === 'function') window.saveState();
          }
        } catch (_) {}
        historyModal.style.display = 'none';
      });
      list.appendChild(b);
    });

    histBody.appendChild(tip);
    histBody.appendChild(list);
    historyModal.style.display = 'flex';
  }

  // 弹窗关闭
  const closeBtn = historyModal.querySelector('.close');
  if (closeBtn) closeBtn.addEventListener('click', () => historyModal.style.display = 'none');
  historyModal.addEventListener('click', function(e){
    if (e.target === historyModal) historyModal.style.display = 'none';
  });
})();
</script>
    <style>
        .corner-links {
            position: fixed;
            right: 20px;
            bottom: 20px;
            display: flex;
            align-items: center;
            z-index: 9999;
        }
        .corner-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            color: #ffffff;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .corner-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 255, 255, 0.15);
        }
        .corner-link img,
        .corner-link svg {
            width: 22px;
            height: 22px;
        }
        .corner-link .label {
            font-weight: 600;
            font-size: 0.95rem;
        }
    </style>
    <div class="corner-links" aria-label="页面固定链接">
        <a class="corner-link" href="https://github.com/IIIStudio/AVGmd" target="_blank" rel="noopener noreferrer" aria-label="前往 GitHub 仓库">
            <!-- 内联 GitHub 图标，避免外部资源依赖 -->
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
                <path fill="#ffffff" d="M12 .5a12 12 0 0 0-3.79 23.41c.6.11.82-.26.82-.58v-2.02c-3.35.73-4.06-1.61-4.06-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.09-.75.08-.74.08-.74 1.2.09 1.83 1.23 1.83 1.23 1.07 1.83 2.8 1.3 3.49.99.11-.78.42-1.3.76-1.6-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.13-.3-.54-1.51.12-3.15 0 0 1.01-.32 3.3 1.23.96-.27 1.99-.4 3.01-.4s2.05.14 3.01.4c2.29-1.55 3.3-1.23 3.3-1.23.66 1.64.25 2.85.12 3.15.77.84 1.24 1.91 1.24 3.22 0 4.61-2.8 5.63-5.47 5.93.43.37.81 1.1.81 2.22v3.29c0 .32.22.7.83.58A12 12 0 0 0 12 .5Z"/>
            </svg>
            <span class="label">AVGmd</span>
        </a>
        <a class="corner-link" href="https://cnb.cool/IIIStudio/HTML/Game/AVGmd/" target="_blank" rel="noopener noreferrer" aria-label="前往 AVGmd 文档页面">
            <img src="https://docs.cnb.cool/images/logo/svg/LogoColorfulIcon.svg" alt="CNB Logo">
        </a>
    </div>
</body>
</html>
