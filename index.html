
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVGmd - 文本冒险游戏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #e8e4d4;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            padding: 10px;
        }
        h1 {
            text-align: center;
            color: #7a7f85;
        }
        h3 {
            color: #7a7f85;
            margin-top: 0;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 2px dotted #2e1111;
        }
        #story {
            display: none; /* 初始隐藏 */
            background-color: #f5f4f1;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px 20px 20px 20px;
            margin-bottom: 20px;
            line-height: 1.5;
            letter-spacing: 0.8px;
        }
        #story2 {

            background-color: #f5f4f1;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px 20px 20px 20px;
            margin-bottom: 20px;
            line-height: 1.5;
            letter-spacing: 0.8px;
        }
        
        #choices {
            margin-top: 10px;
            text-align: center;
        }
        .choice {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            color: #acaba3;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            border: 1px solid #acaba3;
        }
        .choice:hover {
            background-color: #e8e4d4;
        }
        #nextButton {
            padding: 5px 15px;
            font-size: 16px;
            color: #8f7676;
            background-color: #e8e4d4;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
            border: 1px solid #acaba3;
            display: none; /* 初始隐藏 */
        }
        #nextButton:hover{
            background-color: #bba668;
        }
        
        .button-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .button-container input {
            width: 69%;
            padding: 11px;
            font-size: 16px;
            border: 2px solid #cbc09f;
            border-radius: 4px;
            outline: none;
            transition: border-color 0.3s;
        }
        .button-container button {
            padding: 10px 20px;
            font-size: 16px;
            color: #525151;
            background-color: #e8e4d4;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
            border: 1px solid #acaba3;
        }
        
        .button-container button:hover {
            border: 1px solid #525151;
        }
        .min {
            max-height: 25px;
        }
        
        .showImg { cursor: zoom-in; }
        #bigImg { cursor: zoom-out; }
        
        .img-container {
            display: inline-block; /* 或者使用 flex */
            margin: 5px; /* 添加间距 */
        }
        
    </style>
</head>
<body>
<h1>文本冒险游戏</h1>
<div id="story"></div>
<div id="choices"></div>
<button id="nextButton" onclick="showNextLine()">下一步</button>
<div class="button-container">
    <input type="text" id="urlInput" placeholder="输入故事文本文件的URL" />
    <button id="submitButton" onclick="loadStoryFromURL()">提交</button>
    <button onclick="selectFile()">选择TXT文件</button>
</div>

<input type="file" id="fileInput" style="display:none;" />

<div id="story2">
    <h3>使用方式</h3>
    场景1<br>
    这是一个故事，想看吗？<br>
    选择：想 -> 场景2<br>
    选择：不想 -> 场景3<br>
    <br>
    场景2<br>
    结束<br>
    <br>
    场景3<br>
    这是一个很久很久的故事。<br>
    选择：继续 -> 场景4<br>
    <br>
    就是这样写成txt，<选择：想 -> 场景2>就是选择的按键对应到场景2。然后会显示结束。<br>
    每次显示一行，如果需要多行可以使用\n<br>
    例如：<br>
    这是一个很久很久的故事。\n久到所有人忘记了。<br>
    <hr>
    支持插入图片，![](url)<br>
</div>

<!-- 遮罩区域（先将div隐藏）-->
<div id="back-curtain" style="position:fixed;top:0;left:0;background:rgba(0,0,0,0.5);z-index:998;width:100%;display:none;">
    <!--放大后的图片-->
    <div id="imgDiv" style="position:absolute;">
        <img id="bigImg" src="" />
    </div>
</div>

<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.1.min.js"></script>
<script type="text/javascript">
// 图片点击放大
$('.showImg').on('click', function(){
    imgShow("#imgDiv", "#bigImg", $(this), "#back-curtain");
});

function imgShow(imgDiv, bigImg, _this, curtain) {
    // 图片路径
    var src = _this.attr("src");
    $(bigImg).attr("src", src);
    // 加载图片,获取当前点击图片的真实大小
    $("<img/>").attr("src", src).load(function(){
        var windowWidth = $(window).width();
        var windowHeight = $(window).height();
        var realWidth = this.width;
        var realHeight = this.height;
        var imgWidth, imgHeight;
        var scale = 0.8;
        if (realHeight > windowHeight * scale) {
            imgHeight = windowHeight * scale;
            imgWidth = imgHeight / realHeight * realWidth;
            if (imgWidth > windowWidth * scale) {
                imgWidth = windowWidth * scale;
            }
        } else if (realWidth > windowWidth * scale) {
            imgWidth = windowWidth * scale;
            imgHeight = imgWidth / realWidth * realHeight;
        } else {
            imgWidth = realWidth;
            imgHeight = realHeight;
        }
        $(bigImg).css({'width':imgWidth});
        //计算图片与窗口左边距
        var left = (windowWidth - imgWidth) / 2;
        //计算图片与窗口上边距 
        var top = (windowHeight - imgHeight) / 2;
        // 图片位置
        $(imgDiv).css({'top':top, 'left':left});
        // 图片淡入
        $(curtain).fadeIn("fast");
        // 遮罩效果
        $(curtain).css({
            'position':'fixed',
            'overflow-y':'auto',
            'width':'100%',
            'height':'100%',
            'z-index':'998'
        }).show();
    });
    // 点击图片或遮罩，图片淡出
    $(curtain).on('click', function(){
        $(this).fadeOut("fast");
    });
}

let story = {};
let currentScene = "";
let currentLine = 0;
let lines = [];

// 标题设定与解析
function setGameTitle(title) {
    const h1 = document.querySelector('h1');
    const finalTitle = title && String(title).trim() ? String(title).trim() : '文本冒险游戏';
    if (h1) h1.textContent = finalTitle;
    document.title = finalTitle;
}
function deriveTitleFromFileName(name) {
    if (!name) return '文本冒险游戏';
    const base = String(name).split(/[\/\\]/).pop();
    return base.replace(/\.[^.]+$/, '') || '文本冒险游戏';
}
function deriveTitleFromURL(url) {
    if (!url) return '文本冒险游戏';
    try {
        const u = new URL(url);
        const last = (u.pathname || '').split('/').filter(Boolean).pop() || '';
        const raw = last.replace(/\.[^.]+$/, '');
        try {
            return decodeURIComponent(raw) || '文本冒险游戏';
        } catch (e2) {
            return raw || '文本冒险游戏';
        }
    } catch (e) {
        const base = String(url).split('?')[0].split('#')[0];
        const last = base.split('/').pop() || '';
        const raw = last.replace(/\.[^.]+$/, '');
        try {
            return decodeURIComponent(raw) || '文本冒险游戏';
        } catch (e3) {
            return raw || '文本冒险游戏';
        }
    }
}

function selectFile() {
    const fileInput = document.getElementById('fileInput');
    fileInput.click();
    fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result.trim();
                parseStory(text);
                // 根据本地文件名设置标题
                setGameTitle(deriveTitleFromFileName(file.name));
                currentScene = '场景1';
                currentLine = 0;
                displayScene(currentScene);
                document.getElementById('story').style.display = 'block'; // 显示故事
                document.getElementById('story2').style.display = 'none';
                const btnWrap = document.querySelector('.button-container');
                if (btnWrap) btnWrap.style.display = 'none';
            };
            reader.readAsText(file);
        }
    };
}

// 监听键盘事件
document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        if (document.activeElement === document.getElementById('urlInput')) {
            loadStoryFromURL();
        } else {
            showNextLine();
        }
    }
});

function loadStoryFromURL() {
    const urlInput = document.getElementById('urlInput');
    const url = urlInput.value.trim();
    if (!url) return;

    // 清空文件输入
    document.getElementById('fileInput').value = '';

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应错误，状态码：' + response.status);
            }
            return response.text();
        })
        .then(text => {
            parseStory(text);
            // 根据 URL 文件名设置标题
            setGameTitle(deriveTitleFromURL(url));
            currentScene = '场景1';
            currentLine = 0;
            displayScene(currentScene);
            document.getElementById('story').style.display = 'block'; // 显示故事
            document.getElementById('story2').style.display = 'none';
            const btnWrap = document.querySelector('.button-container');
            if (btnWrap) btnWrap.style.display = 'none';
        })
        .catch(error => {
            console.error('加载失败：', error);
            alert('加载失败：' + error.message);
        });
}

function parseStory(text) {
    const scenes = text.split(/\n\s*\n/).map(scene => scene.trim());
    scenes.forEach(scene => {
        const lines = scene.split('\n').map(line => line.trim());
        const sceneName = lines[0];
        const content = lines.slice(1).join('<p>').trim();
        
        // 处理 Markdown 图片
        const processedContent = content.replace(/!\[.*?\]\((.*?)\)/g, '<div class="img-container"><img id="showImg" class="showImg min" src="$1" alt="图片" style="max-width: 100%; height: auto;"></div>');
        
        story[sceneName] = processedContent.split('<p>').map(line => line.replace(/\\n/g, '<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'));
    });
}

function normalizeText(t) {
    return String(t)
        .replace(/<[^>]*>/g, '')        // 去除HTML标签
        .replace(/&nbsp;/g, ' ')        // 替换不间断空格
        .replace(/[\r\n]+/g, '')        // 去除换行符
        .replace(/^[\s\u3000]+|[\s\u3000]+$/g, '') // 去除前后空格（含全角空格）
        .trim();
}
function isEndLine(t) {
    const s = normalizeText(t);
    return /^结束[。\.!！、，…]*$/.test(s);
}

function displayScene(scene) {
    const storyDiv = document.getElementById('story');
    const choicesDiv = document.getElementById('choices');

    if (!story[scene]) {
        storyDiv.innerHTML = "场景不存在。";
        choicesDiv.innerHTML = "";
        return;
    }

    lines = story[scene];
    currentLine = 0;
    // 先清空并隐藏选择，再展示首行，避免首行立即出现选择时被清空
    choicesDiv.innerHTML = "";
    choicesDiv.style.display = 'none';
    showNextLine(); // 显示第一行
}

function showNextLine() {
    const storyDiv = document.getElementById('story');
    const choicesDiv = document.getElementById('choices');

    if (currentLine < lines.length) {
        const currentText = lines[currentLine];

        // 如果是选择行，直接展示选择（不需要额外再点一次）
        if (/^选择：/.test(currentText)) {
            // 跳过所有“选择：”行的内容展示，仅用于生成按钮
            // 将“请选择线路：”附加在当前文本之后显示
            if (!storyDiv.innerHTML.includes("请选择线路：")) {
                storyDiv.innerHTML += "<br>请选择线路：";
            }
            currentLine++; // 前移指针，避免下次仍落在选择行
            showChoices();
            document.getElementById('nextButton').style.display = 'none';
            return;
        }

        // 显示普通文本
        storyDiv.innerHTML = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + currentText;
        currentLine++;

        // 绑定图片放大
        $('.showImg').on('click', function() {
            imgShow("#imgDiv", "#imgDiv #bigImg" ? "#bigImg" : "#bigImg", $(this), "#back-curtain");
        });

        // 如果该行是“结束”，显示结局按钮并停止推进
        if (isEndLine(currentText)) {
            document.getElementById('nextButton').style.display = 'none';
            showEndButtons();
            return;
        }

        // 如果下一行就是选择，则立刻显示选择，避免多一次点击
        if (currentLine < lines.length && /^选择：/.test(lines[currentLine])) {
            storyDiv.innerHTML += "<br>请选择线路：";
            showChoices();
            document.getElementById('nextButton').style.display = 'none';
            choicesDiv.style.display = 'block';
        } else {
            // 否则正常显示“下一步”
            if (currentLine < lines.length) {
                document.getElementById('nextButton').style.display = 'block';
                choicesDiv.style.display = 'none';
            } else {
                document.getElementById('nextButton').style.display = 'none';
                // 到达场景末尾，直接显示结局按钮（兜底）
                showEndButtons();
                choicesDiv.style.display = 'block';
            }
        }
    }
    // 兜底：到达场景末尾时再次检查最后一行是否为“结束”
    else {
        const lastText = lines.length ? lines[lines.length - 1] : '';
        if (isEndLine(lastText)) {
            document.getElementById('nextButton').style.display = 'none';
            showEndButtons();
        }
    }
}

function showEndButtons() {
    const storyDiv = document.getElementById('story');
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = "";

    // 在故事框下加一行空行，确保按钮区域与正文有间距
    if (storyDiv) {
        storyDiv.innerHTML += "<br>";
    }

    const restartBtn = document.createElement('button');
    restartBtn.textContent = '再来一次';
    restartBtn.className = 'choice';
    restartBtn.onclick = () => {
        currentScene = '场景1';
        currentLine = 0;
        displayScene(currentScene);
        const btnWrap = document.querySelector('.button-container');
        if (btnWrap) btnWrap.style.display = 'none'; // 保持输入区隐藏
    };
    choicesDiv.appendChild(restartBtn);

    const endBtn = document.createElement('button');
    endBtn.textContent = '结束';
    endBtn.className = 'choice';
    endBtn.onclick = () => {
        resetToDefault();
    };
    choicesDiv.appendChild(endBtn);

    // 强制显示并滚动到按钮区域，确保用户可见
    choicesDiv.style.display = 'block';
    try {
        choicesDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } catch (e) {}
}

function resetToDefault() {
    const storyDiv = document.getElementById('story');
    const choicesDiv = document.getElementById('choices');
    const guideDiv = document.getElementById('story2');
    const btnWrap = document.querySelector('.button-container');

    storyDiv.style.display = 'none';
    storyDiv.innerHTML = '';
    choicesDiv.innerHTML = '';
    choicesDiv.style.display = 'none';
    if (guideDiv) guideDiv.style.display = 'block';
    if (btnWrap) btnWrap.style.display = 'block';

    // 还原默认标题
    setGameTitle('文本冒险游戏');

    currentScene = '';
    currentLine = 0;
    lines = [];
}

function showChoices() {
    const choicesDiv = document.getElementById('choices');
    choicesDiv.innerHTML = "";

    const choices = lines.join('\n').match(/选择：(.+?) -> (场景\d+)/g);
    if (choices) {
        choices.forEach(choice => {
            const match = choice.match(/选择：(.+?) -> (场景\d+)/);
            if (match) {
                const choiceText = match[1].trim();
                const nextScene = match[2].trim();
                const button = document.createElement('button');
                button.textContent = choiceText;
                button.className = 'choice';
                button.onclick = () => {
                    currentScene = nextScene;
                    currentLine = 0; // 重置行数
                    displayScene(currentScene);
                };
                choicesDiv.appendChild(button);
            }
        });
        choicesDiv.style.display = 'block'; // 显示选择按钮
    } else {
        choicesDiv.style.display = 'none'; // 如果没有选择，隐藏选择按钮
    }
}
</script>
    <style>
        .corner-links {
            position: fixed;
            right: 20px;
            bottom: 20px;
            display: flex;
            align-items: center;
            z-index: 9999;
        }
        .corner-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            color: #212529;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .corner-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .corner-link img,
        .corner-link svg {
            width: 22px;
            height: 22px;
        }
        .corner-link .label {
            font-weight: 600;
            font-size: 0.95rem;
        }
    </style>
    <div class="corner-links" aria-label="页面固定链接">
        <a class="corner-link" href="https://github.com/IIIStudio/AVGmd" target="_blank" rel="noopener noreferrer" aria-label="前往 GitHub 仓库">
            <!-- 内联 GitHub 图标，避免外部资源依赖 -->
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
                <path fill="#24292F" d="M12 .5a12 12 0 0 0-3.79 23.41c.6.11.82-.26.82-.58v-2.02c-3.35.73-4.06-1.61-4.06-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.09-.75.08-.74.08-.74 1.2.09 1.83 1.23 1.83 1.23 1.07 1.83 2.8 1.3 3.49.99.11-.78.42-1.3.76-1.6-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.13-.3-.54-1.51.12-3.15 0 0 1.01-.32 3.3 1.23.96-.27 1.99-.4 3.01-.4s2.05.14 3.01.4c2.29-1.55 3.3-1.23 3.3-1.23.66 1.64.25 2.85.12 3.15.77.84 1.24 1.91 1.24 3.22 0 4.61-2.8 5.63-5.47 5.93.43.37.81 1.1.81 2.22v3.29c0 .32.22.7.83.58A12 12 0 0 0 12 .5Z"/>
            </svg>
            <span class="label">AVGmd</span>
        </a>
        <a class="corner-link" href="https://cnb.cool/IIIStudio/HTML/Game/AVGmd/" target="_blank" rel="noopener noreferrer" aria-label="前往 AVGmd 文档页面">
            <img src="https://docs.cnb.cool/images/logo/svg/LogoColorfulIcon.svg" alt="CNB Logo">
        </a>
    </div>
</body>
</html>
